<!DOCTYPE html>

<html>

  <head>
    <script type="text/javascript" src="plotter.js"></script>
    <script type="text/javascript" src="coordinateGeometry.js"></script>
    <script type="text/javascript" src="coordinateGeometryPlotter.js"></script>
    <script type="text/javascript">
      function Vehicle(wheelbase, wheelRadius, height) {
        // We assume the roof runs the length of the wheelbase.
        this.wheelbase_ = wheelbase;
        this.wheelRadius_ = wheelRadius;
        this.axlesToRoof_ = height - wheelRadius;
      }

      // Traverses the ground and returns the roof height at x=0 at each step.
      // Assumes that the ground runs in the direction of increasing x.
      Vehicle.prototype.traverse = function(ground, doorXCoordinate, step, curvePlotter) {
        assert(ground instanceof Curve);
        assert(ground.getPointAtParameter(0) < ground.getPointAtParameter(1));
        var axlesLocus = ground.shiftOrthogonal(this.wheelRadius_);
        curvePlotter.plot(ground);
        curvePlotter.plot(axlesLocus, {lineColor: 'gray'});
        var parameterStep = step / ground.length();
        var door = new StraightLine(new Vector(doorXCoordinate, 0), new Vector(doorXCoordinate, 1));
        var heights = [];
        for (var parameter = 0; parameter <= 1; parameter += parameterStep) {
          var rearAxlePosition = axlesLocus.getPointAtParameter(parameter);
          var frontAxleIntersections = axlesLocus
              .getIntersectionsWithArc(new Arc(rearAxlePosition, this.wheelbase_, 0, 0, false))
              .filter(function(intersection) {
            return isInZeroOne(intersection.getParameter()) && intersection.getParameter() > parameter;
          });
          if (frontAxleIntersections.length === 0) {
            // We've run out of road
            break;
          }
	  // If the ground contains changes in gradient greater than 90
	  // degrees, there will be multiple intersections, but we don't
	  // support this.
          console.assert(frontAxleIntersections.length === 1);
          var frontAxlePosition = frontAxleIntersections[0].asVector();
          var axlesLine = new StraightLine(rearAxlePosition, frontAxlePosition);
          var roof = axlesLine.shiftOrthogonal(this.axlesToRoof_);
          curvePlotter.plot(axlesLine, {lineColor: 'blue'});
          curvePlotter.plot(roof, {lineColor: 'red'});
          var roofIntersections = roof.getIntersectionsWithStraightLine(door);
          console.assert(roofIntersections.length === 1);
          var roofIntersection = roofIntersections[0];
          // TODO: Use floor height
          heights.push(isInZeroOne(roofIntersection.getParameter()) ? roofIntersection.asVector().getY() : 0);
        }
        return heights;
      };

      function go() {
        // All in mm.
        // track: 1740
        // offset: 600
        var oldData = [
          {y: 43, x: 140},
          {y: 62, x: 1020},
          {y: 77, x: 1150},
          {y: 117, x: 1370},
          {y: 155, x: 1570},
          {y: 197, x: 1750},
          {y: 236, x: 1940},
          {y: 276, x: 2140},
          {y: 308, x: 2380},
          {y: 346, x: 2590},
          {y: 387, x: 2760},
          {y: 421, x: 2940},
        ];
        // offset west: 500
        // offset centre: 1300
        // offset east: 3100
        var thickness = 614 / 15;
        var xStart = -3000;
        var data = [
          {y: 0, east: xStart},
          {y: 0, east: 0},
          /* {y: 20, east: 120}, */
          /* {y: 33, centre: 150}, */
          {y: 52, west: 120},
          {y: 1 * thickness, centre: 1145, east: 825},
          {y: 2 * thickness, west: 990, centre: 1380, east: 1030},
          {y: 3 * thickness, west: 1270, centre: 1630, east: 1185},
          {y: 4 * thickness, west: 1500, centre: 1840, east: 1400},
          {y: 5 * thickness, west: 1720, centre: 2145, east: 1610},
          {y: 6 * thickness, west: 1935, centre: 2290, east: 1755},
          {y: 7 * thickness, west: 2150, centre: 2495, east: 1950},
          {y: 8 * thickness, west: 2355, centre: 2685, east: 2045},
          {y: 9 * thickness, west: 2610, centre: 2895, east: 2320},
          {y: 10 * thickness, west: 2850, centre: 3085, east: 2580},
          {y: 11 * thickness, west: 3060, centre: 3330, east: 2850},
          {y: 12 * thickness, west: 3275, centre: 3480, east: 3020},
          {y: 13 * thickness, west: 3460, centre: 3650, east: 3170},
          {y: 14 * thickness, west: 3570, east: 3360},
          {y: 15 * thickness, east: 3530},
          {y: 15 * thickness + 19, east: 3695},
        ];
        var campervanHeight = Math.max((1949 + 1947) / 2, 1958, (1978 + 1986) / 2, (1970 + 1990) / 2, (1975 + 1992) / 2, (1975 + 1976) / 2);  // Measured
        //var campervanHeight = 78 * 25.4;  // http://www.gowesty.com/tech-article-details.php?id=24
        var campervanHeight = 2070;
        var doorHeight = 2112;  // Worst-case for centre line of campervan
        var doorXCoordinate = 45;
        var wheelbase = 2920;
        var wheelbase = 2800;
        var wheelRadius = 300;  // Measured
        var wheelRadius = 225 * 0.75 + 15 * 25.4 / 2;  // 225/75R15

        var driveway = PolyCurve.fromPoints(data.map(function(entry) {
          return new Vector(Math.min(valueOrInfinity(entry.west), valueOrInfinity(entry.centre), valueOrInfinity(entry.east)), entry.y);
        }));
        plot = new Plot(7000 / 5, 3000 / 5);
        plot.setGridOn(true);
        plot.setHoldOn(true);
        document.body.appendChild(plot.canvas());
        var campervan = new Vehicle(wheelbase, wheelRadius, campervanHeight);
        var opening = PolyCurve.fromPoints([new Vector(xStart, doorHeight), new Vector(doorXCoordinate, doorHeight), new Vector(doorXCoordinate, 3000)]);
        var curvePlotter = new CurvePlotter(plot);
        curvePlotter.plot(opening);
        var heights = campervan.traverse(driveway, 20, 100, curvePlotter);
        var maxHeight = heights.reduce(function(a, b) { return Math.max(a, b); }, 0);

        console.log('Campervan height', Math.ceil(campervanHeight));
        console.log('Extra height', Math.ceil(maxHeight - campervanHeight));
        console.log('Max height', Math.ceil(maxHeight));
        console.log('Door height', Math.floor(doorHeight));
        console.log('Clearance', Math.floor(doorHeight - maxHeight));
      }

      function valueOrInfinity(x) {
        return x === undefined ? Infinity : x;
      }

    </script>
  </head>

  <body onload="go()">
  </body>

</html>
